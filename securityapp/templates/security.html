{% extends "base.html" %}
{% block content %}
<h2>Security Section</h2>
{% if message %}
  <p>{{ message }}</p>
{% endif %}

<form method="post" style="margin-bottom: 20px;">
  {% csrf_token %}
  <input type="hidden" name="action" value="start">
  <button type="submit" class="btn">Start Security System</button>
</form>

<hr>

<h3>Bulk-add faces from server path</h3>
<input id="path"  placeholder="/srv/images/new_set">
<select id="itype">
    <option value="protected">protected</option>
    <option value="warning">warning</option>
</select>
<button id="run-add" class="btn">Run import</button>

<pre id="import-log" style="background:#000;color:#0f0;height:240px;
                            overflow:auto;margin-top:10px;"></pre>

<script>
document.getElementById('run-add').onclick = () => {
    const path  = encodeURIComponent(document.getElementById('path').value);
    const type  = encodeURIComponent(document.getElementById('itype').value);
    const log   = document.getElementById('import-log');
    log.textContent = "";

    const es = new EventSource(
        `{% url 'add_faces_console' %}?path=${path}&type=${type}`
    );

    es.onmessage = e => {
        log.textContent += e.data + "\n";
        log.scrollTop = log.scrollHeight;
    };
    es.addEventListener('done', () => es.close());
    es.onerror = () => { es.close(); log.textContent += "\n[stream stopped]"; };
};
</script>

<hr>

<div id="video-feed" style="margin-top:20px;">
  <h3>Live Video Feed</h3>
  <img id="video-feed-img" src="{% url 'video_feed' %}" alt="Video Feed" style="width:100%;">
</div>

<script>
document.addEventListener('keyup', function(e) {
    if (e.key === "Escape") {
        var videoFeed = document.getElementById('video-feed');
        if (videoFeed) {
            videoFeed.style.display = 'none';
        }
    }
});
</script>
{% endblock %}
